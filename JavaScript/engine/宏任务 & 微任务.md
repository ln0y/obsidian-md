---
aliases: []
tags: ['JavaScript/engine','date/2022-03','year/2022','month/03']
date: 2022-03-03-Thursday 09:44:52
update: 2022-05-10-Tuesday 15:52:28
---

## ä»£ç æ‰§è¡Œé¡ºåº1

æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œç®—æ˜¯å¼€èƒƒçš„å‰èœï¼Œå¦‚æœä½ ä¹‹å‰å¯¹è¿™éƒ¨åˆ†çŸ¥è¯†ç¨æœ‰äº†è§£ï¼Œä¸€èˆ¬éƒ½åº”è¯¥å¯ä»¥å›ç­”æ­£ç¡®ã€‚

```js
console.log('begin')
setTimeout(() => {
  console.log('setTimeout')
}, 0)
new Promise((resolve) => {
  console.log('promise')
  resolve()
}).then(() => {
  console.log('then1')
}).then(() => {
  console.log('then2')
})
console.log('end')
```

è¿™æ®µä»£ç åº”è¯¥æ¯”è¾ƒç®€å•ï¼Œç­”æ¡ˆå°±æ˜¯ï¼š

```plain
begin
promise
end
then1
then2
setTimeout
```

å…¶å®è¿™ä¸ªå°±æ¶‰åŠäº† JavaScript äº‹ä»¶è½®è¯¢ä¸­çš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ã€‚é‚£ä¹ˆè¿™é‡Œæˆ‘å°±ç›´æ¥ç»™å‡ºç»“è®ºï¼Œå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºåŸºæœ¬æ˜¯ï¼Œåœ¨ EventLoop ä¸­ï¼Œæ¯ä¸€æ¬¡å¾ªç¯ç§°ä¸ºä¸€æ¬¡ tickï¼Œä¸»è¦çš„ä»»åŠ¡é¡ºåºå¦‚ä¸‹ï¼š

1. æ‰§è¡Œæ ˆé€‰æ‹©æœ€å…ˆè¿›å…¥é˜Ÿåˆ—çš„å®ä»»åŠ¡ï¼Œæ‰§è¡Œå…¶åŒæ­¥ä»£ç ç›´è‡³ç»“æŸï¼›
2. æ£€æŸ¥æ˜¯å¦æœ‰å¾®ä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼›
3. å¦‚æœæ˜¯åœ¨æµè§ˆå™¨ç«¯ï¼Œé‚£ä¹ˆåŸºæœ¬è¦æ¸²æŸ“é¡µé¢äº†ï¼›
4. å¼€å§‹ä¸‹ä¸€è½®çš„å¾ªç¯ï¼ˆtickï¼‰ï¼Œæ‰§è¡Œå®ä»»åŠ¡ä¸­çš„ä¸€äº›å¼‚æ­¥ä»£ç ï¼Œä¾‹å¦‚ setTimeout ç­‰ã€‚

é‚£ä¹ˆç»“åˆè¿™ä¸ªç»“è®ºï¼Œä»¥åŠ [[EventLoop]] çš„å†…å®¹ï¼Œæ¥çœ‹ä¸‹å®ƒä»¬çš„è¿è½¬æµç¨‹æ•ˆæœå›¾ã€‚

![[Cgp9HWBQhFyAf7TxAAK_oyhU5eM671.png|800]]

Call-Stackï¼ˆè°ƒç”¨æ ˆï¼‰ä¹Ÿå°±æ˜¯æ‰§è¡Œæ ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ˆçš„ç»“æ„ï¼Œç¬¦åˆå…ˆè¿›åå‡ºçš„æœºåˆ¶ï¼Œæ¯æ¬¡ä¸€ä¸ªå¾ªç¯ï¼Œå…ˆæ‰§è¡Œæœ€å…ˆå…¥é˜Ÿçš„å®ä»»åŠ¡ï¼Œç„¶åå†æ‰§è¡Œå¾®ä»»åŠ¡ã€‚ä¸ç®¡å¾®ä»»åŠ¡è¿˜æ˜¯å®ä»»åŠ¡ï¼Œå®ƒä»¬åªè¦æŒ‰ç…§é¡ºåºè¿›å…¥äº†æ‰§è¡Œæ ˆï¼Œé‚£ä¹ˆæ‰§è¡Œæ ˆå°±è¿˜æ˜¯æŒ‰ç…§å…ˆè¿›åå‡ºçš„è§„åˆ™ï¼Œä¸€æ­¥ä¸€æ­¥æ‰§è¡Œã€‚

å› æ­¤æ ¹æ®è¿™ä¸ªåŸåˆ™ï¼Œæœ€å…ˆè¿›è¡Œè°ƒç”¨æ ˆçš„å®ä»»åŠ¡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯æœ€åè¿”å›æ‰§è¡Œçš„ç»“æœã€‚é‚£ä¹ˆä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ° setTimeout çš„ç¡®æœ€åæ‰§è¡Œäº†æ‰“å°çš„ç»“æœã€‚

## å®ä»»åŠ¡

å¦‚æœåœ¨æµè§ˆå™¨çš„ç¯å¢ƒä¸‹ï¼Œå®ä»»åŠ¡ä¸»è¦åˆ†ä¸ºä¸‹é¢è¿™å‡ ä¸ªå¤§ç±»ï¼š

1. æ¸²æŸ“äº‹ä»¶ï¼ˆæ¯”å¦‚è§£æ DOMã€è®¡ç®—å¸ƒå±€ã€ç»˜åˆ¶ï¼‰ï¼›
2. ç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆæ¯”å¦‚é¼ æ ‡ç‚¹å‡»ã€æ»šåŠ¨é¡µé¢ã€æ”¾å¤§ç¼©å°ç­‰ï¼‰ï¼›
3. setTimeoutã€setInterval ç­‰ï¼›
4. ç½‘ç»œè¯·æ±‚å®Œæˆã€æ–‡ä»¶è¯»å†™å®Œæˆäº‹ä»¶ã€‚

ä¸ºäº†è®©è¿™äº›ä»»åŠ¡åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œé¡µé¢è¿›ç¨‹å¼•å…¥äº†æ¶ˆæ¯é˜Ÿåˆ—å’Œäº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œæˆ‘ä»¬æŠŠè¿™äº›æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ç§°ä¸ºå®ä»»åŠ¡ã€‚å®ä»»åŠ¡åŸºæœ¬ä¸Šæ»¡è¶³äº†æ—¥å¸¸çš„å¼€å‘éœ€æ±‚ï¼Œè€Œå¯¹äºæ—¶é—´ç²¾åº¦æœ‰è¦æ±‚çš„å®ä»»åŠ¡å°±ä¸å¤ªèƒ½æ»¡è¶³äº†ï¼Œæ¯”å¦‚æ¸²æŸ“äº‹ä»¶ã€å„ç§ I/Oã€ç”¨æˆ·äº¤äº’çš„äº‹ä»¶ç­‰ï¼Œéƒ½éšæ—¶æœ‰å¯èƒ½è¢«æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼ŒJS ä»£ç ä¸èƒ½å‡†ç¡®æŒæ§ä»»åŠ¡è¦æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œæ§åˆ¶ä¸äº†ä»»åŠ¡åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œæ‰€ä»¥å¾ˆéš¾æ§åˆ¶å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ã€‚

ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹é¢çš„è¿™æ®µä»£ç ã€‚

```js
function callback2 () {
  console.log(2)
}
function callback () {
  console.log(1)
  setTimeout(callback2, 0)
}
setTimeout(callback, 0)
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘çš„ç›®çš„æ˜¯æƒ³é€šè¿‡ setTimeout æ¥è®¾ç½®ä¸¤ä¸ªå›è°ƒä»»åŠ¡ï¼Œå¹¶è®©å®ƒä»¬æŒ‰ç…§å‰åé¡ºåºæ¥æ‰§è¡Œï¼Œä¸­é—´ä¹Ÿä¸è¦å†æ’å…¥å…¶ä»–çš„ä»»åŠ¡ã€‚ä½†æ˜¯å®é™…æƒ…å†µæˆ‘ä»¬éš¾ä»¥æ§åˆ¶ï¼Œæ¯”å¦‚åœ¨ä½ è°ƒç”¨ setTimeout æ¥è®¾ç½®å›è°ƒä»»åŠ¡çš„é—´éš™ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å°±æœ‰å¯èƒ½è¢«æ’å…¥å¾ˆå¤šç³»ç»Ÿçº§çš„ä»»åŠ¡ã€‚å¦‚æœä¸­é—´è¢«æ’å…¥çš„ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡ä¹…çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå½±å“åˆ°åé¢ä»»åŠ¡çš„æ‰§è¡Œäº†ã€‚æ‰€ä»¥è¯´å®ä»»åŠ¡çš„æ—¶é—´ç²’åº¦æ¯”è¾ƒå¤§ï¼Œæ‰§è¡Œçš„é—´éš”æ˜¯ä¸èƒ½ç²¾ç¡®æ§åˆ¶çš„ã€‚è¿™å°±ä¸é€‚ç”¨äºä¸€äº›é«˜å®æ—¶æ€§çš„éœ€æ±‚äº†ï¼Œæ¯”å¦‚åé¢è¦è®²åˆ°çš„ç›‘å¬ DOM å˜åŒ–ã€‚

## å¾®ä»»åŠ¡

åœ¨ç†è§£äº†å®ä»»åŠ¡ä¹‹åï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯å¾®ä»»åŠ¡äº†ã€‚å¾®ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªéœ€è¦å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°ï¼Œæ‰§è¡Œæ—¶æœºæ˜¯åœ¨ä¸»å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åã€å½“å‰å®ä»»åŠ¡ç»“æŸä¹‹å‰ã€‚

æˆ‘ä»¬çŸ¥é“å½“ JavaScript æ‰§è¡Œä¸€æ®µè„šæœ¬çš„æ—¶å€™ï¼ŒV8 ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ V8 å¼•æ“ä¹Ÿä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è¿™ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—å°±æ˜¯ç”¨æ¥å­˜æ”¾å¾®ä»»åŠ¡çš„ï¼Œå› ä¸ºåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™ä¼šäº§ç”Ÿå¤šä¸ªå¾®ä»»åŠ¡ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨è¿™ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—æ¥ä¿å­˜è¿™äº›å¾®ä»»åŠ¡äº†ã€‚ä¸è¿‡è¿™ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯ç»™ V8 å¼•æ“å†…éƒ¨ä½¿ç”¨çš„ï¼Œæ‰€ä»¥ä½ æ˜¯æ— æ³•é€šè¿‡ JavaScript ç›´æ¥è®¿é—®çš„ã€‚

é‚£ä¹ˆå¾®ä»»åŠ¡æ˜¯æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Ÿåœ¨ç°ä»£æµè§ˆå™¨é‡Œé¢ï¼Œäº§ç”Ÿå¾®ä»»åŠ¡æœ‰ä¸¤ç§æ–¹å¼ã€‚

1. ä½¿ç”¨ MutationObserver ç›‘æ§æŸä¸ª DOM èŠ‚ç‚¹ï¼Œæˆ–è€…ä¸ºè¿™ä¸ªèŠ‚ç‚¹æ·»åŠ ã€åˆ é™¤éƒ¨åˆ†å­èŠ‚ç‚¹ï¼Œå½“ DOM èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šäº§ç”Ÿ DOM å˜åŒ–è®°å½•çš„å¾®ä»»åŠ¡ã€‚
2. ä½¿ç”¨ Promiseï¼Œå½“è°ƒç”¨ Promise.resolve() æˆ–è€… Promise.reject() çš„æ—¶å€™ï¼Œä¹Ÿä¼šäº§ç”Ÿå¾®ä»»åŠ¡ã€‚

é€šè¿‡ DOM èŠ‚ç‚¹å˜åŒ–äº§ç”Ÿçš„å¾®ä»»åŠ¡æˆ–è€…ä½¿ç”¨ Promise äº§ç”Ÿçš„å¾®ä»»åŠ¡éƒ½ä¼šè¢« JS å¼•æ“æŒ‰ç…§é¡ºåºä¿å­˜åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚ç°åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰äº†å¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦çœ‹çœ‹å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä½•æ—¶è¢«æ‰§è¡Œçš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨å½“å‰å®ä»»åŠ¡ä¸­çš„ JavaScript å¿«æ‰§è¡Œå®Œæˆæ—¶ï¼Œä¹Ÿå°±æ˜¯åœ¨ JavaScript å¼•æ“å‡†å¤‡é€€å‡ºå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å¹¶æ¸…ç©ºè°ƒç”¨æ ˆçš„æ—¶å€™ï¼ŒJavaScript å¼•æ“ä¼šæ£€æŸ¥å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åæŒ‰ç…§é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡ã€‚

å¦‚æœåœ¨æ‰§è¡Œå¾®ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œä¸€æ ·ä¼šå°†è¯¥å¾®ä»»åŠ¡æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ŒV8 å¼•æ“ä¸€ç›´å¾ªç¯æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œç›´åˆ°é˜Ÿåˆ—æ¸…ç©ºæ‰ç®—æ‰§è¡Œç»“æŸã€‚ä¹Ÿå°±æ˜¯è¯´**åœ¨æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡å¹¶ä¸ä¼šæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨å½“å‰çš„å¾ªç¯ä¸­ç»§ç»­æ‰§è¡Œ**ï¼Œè¿™ç‚¹æ˜¯éœ€è¦æ³¨æ„çš„ã€‚

ä»¥ä¸Šå°±æ˜¯å¾®ä»»åŠ¡çš„å·¥ä½œæµç¨‹ï¼Œä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹å‡ ä¸ªç»“è®ºã€‚

1. å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡æ˜¯ç»‘å®šçš„ï¼Œæ¯ä¸ªå®ä»»åŠ¡åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šåˆ›å»ºè‡ªå·±çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
2. å¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é•¿ä¼šå½±å“å½“å‰å®ä»»åŠ¡çš„æ—¶é•¿ã€‚æ¯”å¦‚ä¸€ä¸ªå®ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿäº† 10 ä¸ªå¾®ä»»åŠ¡ï¼Œæ‰§è¡Œæ¯ä¸ªå¾®ä»»åŠ¡çš„æ—¶é—´æ˜¯ 10msï¼Œé‚£ä¹ˆæ‰§è¡Œè¿™ 10 ä¸ªå¾®ä»»åŠ¡çš„æ—¶é—´å°±æ˜¯ 100msï¼Œä¹Ÿå¯ä»¥è¯´è¿™ 10 ä¸ªå¾®ä»»åŠ¡è®©å®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å»¶é•¿äº† 100msã€‚
3. åœ¨ä¸€ä¸ªå®ä»»åŠ¡ä¸­ï¼Œåˆ†åˆ«åˆ›å»ºä¸€ä¸ªç”¨äºå›è°ƒçš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œå¾®ä»»åŠ¡éƒ½æ—©äºå®ä»»åŠ¡æ‰§è¡Œã€‚

## ç›‘å¬ DOM å˜åŒ–åº”ç”¨åœºæ™¯

MutationObserver æ˜¯ç”¨æ¥ç›‘å¬ DOM å˜åŒ–çš„ä¸€å¥—æ–¹æ³•ï¼Œè€Œç›‘å¬ DOM å˜åŒ–ä¸€ç›´æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆç»å¸¸è¦åšçš„äº‹æƒ…ä¹‹ä¸€ã€‚

è™½ç„¶ç›‘å¬ DOM çš„éœ€æ±‚æ˜¯æ¯”è¾ƒé¢‘ç¹çš„ï¼Œä¸è¿‡æ—©æœŸé¡µé¢å¹¶æ²¡æœ‰æä¾›å¯¹ç›‘å¬çš„æ”¯æŒï¼Œæ‰€ä»¥é‚£æ—¶è¦è§‚å¯Ÿ DOM æ˜¯å¦å˜åŒ–ï¼Œå”¯ä¸€èƒ½åšçš„å°±æ˜¯è½®è¯¢æ£€æµ‹ã€‚æ¯”å¦‚ä½¿ç”¨ setTimeout æˆ–è€… setInterval æ¥å®šæ—¶æ£€æµ‹ DOM æ˜¯å¦æœ‰æ”¹å˜ã€‚è¿™ç§æ–¹å¼ç®€å•ç²—æš´ï¼Œä½†æ˜¯ä¼šé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼šå¦‚æœæ—¶é—´é—´éš”è®¾ç½®è¿‡é•¿ï¼ŒDOM å˜åŒ–å“åº”ä¸å¤ŸåŠæ—¶ï¼›åè¿‡æ¥å¦‚æœæ—¶é—´é—´éš”è®¾ç½®è¿‡çŸ­ï¼Œåˆä¼šæµªè´¹å¾ˆå¤šæ— ç”¨çš„å·¥ä½œé‡å»æ£€æŸ¥ DOMï¼Œä¼šè®©é¡µé¢å˜å¾—ä½æ•ˆã€‚

ä» DOM 4 å¼€å§‹ï¼ŒW3C æ¨å‡ºäº† MutationObserverã€‚MutationObserver API å¯ä»¥ç”¨æ¥ç›‘è§† DOM çš„å˜åŒ–ï¼ŒåŒ…æ‹¬å±æ€§çš„å˜æ›´ã€èŠ‚ç‚¹çš„å¢åŠ ã€å†…å®¹çš„æ”¹å˜ç­‰ã€‚å› ä¸ºä¸Šé¢æˆ‘ä»¬åˆ†æè¿‡ï¼Œåœ¨ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´ï¼Œå¯èƒ½ä¼šè¢«æ¸²æŸ“è¿›ç¨‹æ’å…¥å…¶ä»–çš„äº‹ä»¶ï¼Œä»è€Œå½±å“åˆ°å“åº”çš„å®æ—¶æ€§ã€‚è¿™æ—¶å€™ï¼Œå¾®ä»»åŠ¡å°±å¯ä»¥ä¸Šåœºäº†ï¼Œåœ¨æ¯æ¬¡ DOM èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ¸²æŸ“å¼•æ“å°†å˜åŒ–è®°å½•å°è£…æˆå¾®ä»»åŠ¡ï¼Œå¹¶å°†å¾®ä»»åŠ¡æ·»åŠ è¿›å½“å‰çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚è¿™æ ·å½“æ‰§è¡Œåˆ°æ£€æŸ¥ç‚¹çš„æ—¶å€™ï¼ŒV8 å¼•æ“å°±ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œå¾®ä»»åŠ¡äº†ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒMutationObserver é‡‡ç”¨äº†â€œå¼‚æ­¥ + å¾®ä»»åŠ¡â€çš„ç­–ç•¥ï¼š

- é€šè¿‡å¼‚æ­¥æ“ä½œè§£å†³äº†åŒæ­¥æ“ä½œçš„æ€§èƒ½é—®é¢˜ï¼›
- é€šè¿‡å¾®ä»»åŠ¡è§£å†³äº†å®æ—¶æ€§çš„é—®é¢˜ã€‚

## ä»£ç æ‰§è¡Œé¡ºåº2

è¯·ä½ æ¥ç€çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå®ƒçš„æ‰§è¡Œç»“æœæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

```js
async function async1 () {
  console.log("async1 start")
  await async2()
  console.log("async1 end")
}
async function async2 () {
  console.log("async2")
}
async1()
setTimeout(() => {
  console.log("timeout")
}, 0)
new Promise(function (resolve) {
  console.log("promise1")
  resolve()
}).then(function () {
  console.log("promise2")
})
console.log("script end")
```

```
async1 start
async2
promise1
script end
async1 end
promise2
timeout
```

## æ€»ç»“

|                    | å®ä»»åŠ¡ï¼ˆMacrotaskï¼‰                                                                                                                   | å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰                                                                                           |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| ç›¸åº”çš„æ–¹æ³•äº‹ä»¶     | 1.scriptä»£ç å—<br>2.setTimeout/setInterval<br>3.UI rendering/UIäº‹ä»¶<br>4.postMessage,MessageChannel<br>5.setImmediate(Node.js) <br>6.I/Oï¼Œäº‹ä»¶é˜Ÿåˆ—| 1.Promise<br>2.MutaionObserver<br>3.Object.observe(Proxyå¯¹è±¡æ›¿ä»£)<br>4.process.nextTick(Node.js)<br>5.queueMicrotask |
| è¿è¡Œé¡ºåº           | åè¿è¡Œ                                                                                                                   | å…ˆè¿è¡Œ                                                                                           |
| æ˜¯å¦è§¦å‘æ–°ä¸€è½®tick | ä¼š                                                                                                                       | ä¸ä¼š                                                                                             |

**å¦‚ä½•ç†è§£ scriptï¼ˆæ•´ä½“ä»£ç å—ï¼‰æ˜¯ä¸ªå®ä»»åŠ¡å‘¢** ğŸ¤”

å®é™…ä¸Šå¦‚æœåŒæ—¶å­˜åœ¨ä¸¤ä¸ª script ä»£ç å—ï¼Œä¼šé¦–å…ˆåœ¨æ‰§è¡Œç¬¬ä¸€ä¸ª script ä»£ç å—ä¸­çš„åŒæ­¥ä»£ç ï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹ä¸­åˆ›å»ºäº†å¾®ä»»åŠ¡å¹¶è¿›å…¥äº†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¬¬ä¸€ä¸ª script åŒæ­¥ä»£ç æ‰§è¡Œå®Œä¹‹åï¼Œä¼šé¦–å…ˆå»æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå†å»å¼€å¯ç¬¬äºŒä¸ª script ä»£ç å—çš„æ‰§è¡Œã€‚æ‰€ä»¥è¿™é‡Œåº”è¯¥å°±å¯ä»¥ç†è§£ scriptï¼ˆæ•´ä½“ä»£ç å—ï¼‰ä¸ºä»€ä¹ˆä¼šæ˜¯å®ä»»åŠ¡ã€‚
